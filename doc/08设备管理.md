# 设备管理

本地模式时：
>请求URL: http://dev-ip-addr:port:/api/device
>请求类型: POST
>HTTP头：token = , 使用登陆时返回的token
>请求消息体:JSON
>返回消息体:JSON, retcode = 0时正确， 非0时出错

智云模式时：
>消息体、返回体相关，无http相关内容

**上传升级文件时，请求URL为http://dev-ip-addr:port:/api/upload**
**下载快照文件时，请求URL为http://dev-ip-addr:port:/api/download**

设备管理接口：

1. 设置时间：
- 请求
```json
{
    "action":"time",
    "timezone":-480,
    "timestamp":16158920080028
}
```
> timezone : 时区；与格林尼治时间差的分钟数，负数为东区，正数为西区
> timestamp ： 1970.1.1 开始的毫秒数；

- 响应
```json
{
    "retcode":0
}
```

2. 设备重启
- 请求
```json
{
    "action":"reboot"
}
```

- 响应
```json
{
    "retcode":0
}
```


3. 设备重置
- 请求
```json
{
    "action":"reset"
}
```
>**设备内的所有数据被清空，恢复到出厂状态，危险操作**

- 响应
```json
{
    "retcode":0
}
```

4. 配置网络
- 请求
```json
{
    "action":"netconfig",
    "type":"eth",
    "mode":"static",
    "ipv4-address":"192.168.20.10",
    "ipv4-mask":"255.255.255.0",
    "ipv4-gateway":"192.168.20.1",
    "ipv4-dns":"114.114.114.114"
}
```
> type: 应用的配置类似：eth - 以太网口， wifi - wifi配置
> mode: staticip 静态网址；dynamic 动态网址
> ipv4-address: 静态配置时， IPv4地址
> ipv4-mask: 静态配置时，网址掩码
> ipv4-gateway: 静态配置时，网关地址
> ipv4-dns: 静态配置时，dns服务器地址

- 响应
```json
{
    "retcode":0
}
```

5. 激活设备
**仅智云模式，由小程序/app激活设备时使用**
- 请求
```json
{
    "action":"activate"
}
```
> 激活设备

- 响应
```json
{
    "retcode":0
}
```

6. 远程开门

- 请求
```json
{
    "action":"opendoor",
    "userid":"1avsoHu2EeqZmH943F8eUg=="
}
```

- 响应
```json
{
    "retcode":0
}
```

7. 上传升级文件
**上传升级文件时，请求URL为http://dev-ip-addr:port:/api/upload**
- 请求
```json
{
    "action":"pushdata",
    "type":"upgrade",
    "filesize":32678,
    "filename":"walos-v2.3.4.bin",
    "offset":4096,
    "size": 4096,
    "data":"base64-encoded file data"
}
```
>type : 上传数据的类型，升级文件
>filename : 升级文件名
>filesize : 文件总的长度
>offset : 当前数据片段起始位置
>size : 当前数据片段长度
>data : base64编码的数据

- 响应
```json
{
    "retcode":0
}
```

8. 升级设备

- 请求
```json
{
    "action":"upgrade",
    "filename":"walos-v2.3.4.bin"
}
```

- 响应
```json
{
    "retcode":0
}
```

9. 传感器快照
- 请求
```json
{
    "action":"snapshot"
}
```
> 获取设备摄像头的快照图片

- 响应
```json
{
    "retcode": 0,
    "timestamp": "1587985190"
}
```
>timestamp 为获取快照的时间戳，下载快照时需要此数据

10. 下载快照文件
**下载快照文件时，请求URL为http://dev-ip-addr:port:/api/download**
- 请求
```json
{
    "action":"pulldata",
    "type":"snapshot",
    "chanel":0,
    "offset":0,
    "size": 32000,
    "timestamp":1584518255389
}
```
> timestamp : 生成快照时返回的时间戳
> chanel : 准备获取的摄像头通道

- 响应
```json
{
    "action":"pushdata",
    "type":"snapshot",
    "filesize":32678,
    "filename":"SNAP0-1584518255389.nv12",
    "offset":0,
    "size": 32000,
    "data":"base64-encoded file data"
}
```


11. 设置模式
设备运行在不同模式时，表示不同的功能，主要有三种模式：门锁模式：平时设备不点亮屏显与补光灯，当触摸按键时，点亮屏显+补光灯，识别人脸后开门或者读取开锁二维码后开门；门禁模式：正常工作时进行人脸识别，识别后开门。识别期间可以通过按键进入访客二维码读码状态，读取访客码并开门。同时门禁支持广告播放方案，开启后主界面将播放广告，不显示人脸视频；测温模式：分为腕温测温与额温测温，两种测温模块可选，对于识别部分可以是人脸识别开门或口罩提醒开门，但不建议同时进行。其中门禁模式与测温模式都支持后台考勤方案。
>1. 门锁模式：（按键唤醒） + （[人脸识别]/[密码二维码]） + （开门）；
>2. 门禁模式：（人脸识别） + [访客二维码] + [广告播放] + [开门]；
>3. 测温模式：（[腕温测温]/[额温测温]） + [\[人脸识别]/[口罩提醒]] + （拍照） + [开门]；


- 请求
```json 
{
    "action":"mode",
    "type":"lock",
    "face":0,
    "qrcode":0,
    "therm":0,
    "door":0
}
```
> type : lock 门锁模式， acs 门禁模式， therm 测温模式；
> face : 是否进行人脸识别: 0 不识别，1正常识别， 2口罩提醒
> qrcode : 是否支持二维码扫码；
> therm : 测温方案：0 无， 1 腕温， 2 额温；
> door : 0 不开门， 1 开门

- 响应
```json
{
    "retcode":0
}
```
